<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Comfort Hoetel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/style.css">
  <style>
    body {
      background: #f8f9fa;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      border-left: 4px solid #667eea;
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .action-buttons button {
      margin-right: 0.5rem;
    }
    
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .status-pending { background: #ffc107; color: #000; }
    .status-confirmed { background: #28a745; color: white; }
    .status-checked-in { background: #17a2b8; color: white; }
    .status-completed { background: #6c757d; color: white; }
    .status-cancelled { background: #dc3545; color: white; }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    #bookingsTable {
      font-size: 0.9rem;
    }
    
    #bookingsTable th {
      background: #f8f9fa;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">üè® Comfort Hoetel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <span class="navbar-text me-3">
            <i class="fas fa-user-circle"></i> <span id="userDisplay">Loading...</span>
          </span>
        </li>
        <li class="nav-item">
          <button class="btn btn-outline-light btn-sm" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="dashboard-header">
  <div class="container">
    <h2><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h2>
    <p class="mb-0">Manage hotel bookings and operations</p>
  </div>
</div>

<div class="container mb-5">
  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card stat-card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Bookings</h6>
              <h3 class="mb-0" id="totalBookings">0</h3>
            </div>
            <i class="fas fa-calendar-check fa-2x text-primary"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Pending</h6>
              <h3 class="mb-0 text-warning" id="pendingBookings">0</h3>
            </div>
            <i class="fas fa-clock fa-2x text-warning"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Confirmed</h6>
              <h3 class="mb-0 text-success" id="confirmedBookings">0</h3>
            </div>
            <i class="fas fa-check-circle fa-2x text-success"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card stat-card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="text-muted mb-1">Total Revenue</h6>
              <h3 class="mb-0 text-info" id="totalRevenue">$0</h3>
            </div>
            <i class="fas fa-dollar-sign fa-2x text-info"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bookings Table -->
  <div class="card shadow">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-list"></i> All Bookings</h5>
      <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="fas fa-plus"></i> Create New Booking
      </button>
    </div>
    <div class="card-body p-0">
      <div class="p-3 border-bottom">
        <div class="row g-2">
          <div class="col-md-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by guest name or email...">
          </div>
          <div class="col-md-2">
            <select class="form-select" id="statusFilter">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="checked-in">Checked In</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="loadBookings()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="bookingsTable">
          <thead>
            <tr>
              <th>Booking ID</th>
              <th>Guest Name</th>
              <th>Email</th>
              <th>Room</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Guests</th>
              <th>Total</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="bookingsBody">
            <tr>
              <td colspan="10" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading bookings...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Create New Booking</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="bookingForm">
          <input type="hidden" id="bookingId">
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Room Name *</label>
              <select class="form-select" id="roomName" required>
                <option value="">Select Room</option>
                <option value="Deluxe Suite">Deluxe Suite</option>
                <option value="Executive Room">Executive Room</option>
                <option value="Standard Room">Standard Room</option>
                <option value="Family Suite">Family Suite</option>
                <option value="Presidential Suite">Presidential Suite</option>
                <option value="Ocean View Room">Ocean View Room</option>
                <option value="Garden View Room">Garden View Room</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">Room Type *</label>
              <select class="form-select" id="roomType" required>
                <option value="">Select Type</option>
                <option value="suite">Suite</option>
                <option value="executive">Executive</option>
                <option value="standard">Standard</option>
                <option value="family">Family</option>
                <option value="presidential">Presidential</option>
                <option value="ocean-view">Ocean View</option>
                <option value="garden-view">Garden View</option>
              </select>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Guest Name *</label>
              <input type="text" class="form-control" id="guestName" required>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">Guest Email *</label>
              <input type="email" class="form-control" id="guestEmail" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Guest Phone</label>
              <input type="tel" class="form-control" id="guestPhone" placeholder="+1-555-123-4567">
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">Number of Guests *</label>
              <input type="number" class="form-control" id="numberOfGuests" min="1" max="10" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Check-In Date *</label>
              <input type="date" class="form-control" id="checkInDate" required>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">Check-Out Date *</label>
              <input type="date" class="form-control" id="checkOutDate" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Total Price ($) *</label>
              <input type="number" class="form-control" id="totalPrice" step="0.01" min="0" required>
            </div>
            
            <div class="col-md-6 mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" id="status">
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="checked-in">Checked In</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Special Requests</label>
            <textarea class="form-control" id="specialRequests" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveBooking()">
          <i class="fas fa-save"></i> Save Booking
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let allBookings = [];
  let currentUser = null;
  
  // Check authentication on page load
  async function checkAuth() {
    try {
      const response = await fetch('/api/auth/status', { credentials: 'same-origin' });
      const data = await response.json();
      
      if (!data.authenticated) {
        window.location.href = '/admin?error=Please login first';
        return false;
      }
      
      currentUser = data.user;
      document.getElementById('userDisplay').textContent = data.user.fullName;
      
      // Show role badge
      const roleText = data.user.role === 'admin' ? 'Administrator' : 'Manager';
      document.getElementById('userDisplay').textContent += ` (${roleText})`;
      
      return true;
    } catch (error) {
      console.error('Auth check failed:', error);
      window.location.href = '/admin';
      return false;
    }
  }
  
  // Logout function
  async function logout() {
    try {
      await fetch('/admin/logout', { method: 'POST', credentials: 'same-origin' });
      window.location.href = '/admin';
    } catch (error) {
      console.error('Logout failed:', error);
      alert('Logout failed. Please try again.');
    }
  }
  
  // Load all bookings
  async function loadBookings() {
    try {
      const response = await fetch('/api/bookings', { credentials: 'same-origin' });
      allBookings = await response.json();
      
      updateStatistics();
      displayBookings(allBookings);
    } catch (error) {
      console.error('Error loading bookings:', error);
      document.getElementById('bookingsBody').innerHTML = `
        <tr><td colspan="10" class="text-center text-danger py-5">
          <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
          <p>Error loading bookings. Please refresh the page.</p>
        </td></tr>
      `;
    }
  }
  
  // Update statistics
  function updateStatistics() {
    const total = allBookings.length;
    const pending = allBookings.filter(b => b.status === 'pending').length;
    const confirmed = allBookings.filter(b => b.status === 'confirmed').length;
    const revenue = allBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
    
    document.getElementById('totalBookings').textContent = total;
    document.getElementById('pendingBookings').textContent = pending;
    document.getElementById('confirmedBookings').textContent = confirmed;
    document.getElementById('totalRevenue').textContent = '$' + revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }
  
  // Display bookings in table
  function displayBookings(bookings) {
    const tbody = document.getElementById('bookingsBody');
    
    if (bookings.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="10" class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <p class="text-muted">No bookings found</p>
        </td></tr>
      `;
      return;
    }
    
    tbody.innerHTML = bookings.map(booking => {
      const checkIn = new Date(booking.checkInDate).toLocaleDateString();
      const checkOut = new Date(booking.checkOutDate).toLocaleDateString();
      const statusClass = `status-${booking.status}`;
      const shortId = booking._id.substring(booking._id.length - 6);
      
      return `
        <tr>
          <td><code>${shortId}</code></td>
          <td>${booking.guestName}</td>
          <td>${booking.guestEmail}</td>
          <td>${booking.roomName}</td>
          <td>${checkIn}</td>
          <td>${checkOut}</td>
          <td>${booking.numberOfGuests}</td>
          <td>$${booking.totalPrice.toFixed(2)}</td>
          <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
          <td class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="viewBooking('${booking._id}')" title="View">
              <i class="fas fa-eye"></i>
            </button>
            ${currentUser && currentUser.role === 'admin' ? `
            <button class="btn btn-sm btn-warning" onclick="editBooking('${booking._id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking._id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
            ` : ''}
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // Filter bookings
  document.getElementById('searchInput')?.addEventListener('input', filterBookings);
  document.getElementById('statusFilter')?.addEventListener('change', filterBookings);
  
  function filterBookings() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filtered = allBookings;
    
    if (searchTerm) {
      filtered = filtered.filter(b => 
        b.guestName.toLowerCase().includes(searchTerm) ||
        b.guestEmail.toLowerCase().includes(searchTerm)
      );
    }
    
    if (statusFilter) {
      filtered = filtered.filter(b => b.status === statusFilter);
    }
    
    displayBookings(filtered);
  }
  
  // Open create modal
  function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Create New Booking';
    document.getElementById('bookingForm').reset();
    document.getElementById('bookingId').value = '';
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('checkInDate').min = today;
    document.getElementById('checkOutDate').min = today;
    
    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    modal.show();
  }
  
  // View booking details
  function viewBooking(id) {
    const booking = allBookings.find(b => b._id === id);
    if (!booking) return;
    
    const details = `
      <strong>Guest Name:</strong> ${booking.guestName}<br>
      <strong>Email:</strong> ${booking.guestEmail}<br>
      <strong>Phone:</strong> ${booking.guestPhone || 'N/A'}<br>
      <strong>Room:</strong> ${booking.roomName} (${booking.roomType})<br>
      <strong>Check-In:</strong> ${new Date(booking.checkInDate).toLocaleDateString()}<br>
      <strong>Check-Out:</strong> ${new Date(booking.checkOutDate).toLocaleDateString()}<br>
      <strong>Duration:</strong> ${booking.duration} nights<br>
      <strong>Guests:</strong> ${booking.numberOfGuests}<br>
      <strong>Total Price:</strong> $${booking.totalPrice.toFixed(2)}<br>
      <strong>Status:</strong> ${booking.status}<br>
      <strong>Special Requests:</strong> ${booking.specialRequests || 'None'}<br>
      <strong>Created:</strong> ${new Date(booking.created_at).toLocaleString()}
    `;
    
    alert('Booking Details:\n\n' + details.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, ''));
  }
  
  // Edit booking
  function editBooking(id) {
    // Check if user is admin
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Access Denied: Only administrators can edit bookings.');
      return;
    }
    
    const booking = allBookings.find(b => b._id === id);
    if (!booking) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Booking';
    document.getElementById('bookingId').value = booking._id;
    document.getElementById('roomName').value = booking.roomName;
    document.getElementById('roomType').value = booking.roomType;
    document.getElementById('guestName').value = booking.guestName;
    document.getElementById('guestEmail').value = booking.guestEmail;
    document.getElementById('guestPhone').value = booking.guestPhone || '';
    document.getElementById('numberOfGuests').value = booking.numberOfGuests;
    document.getElementById('checkInDate').value = new Date(booking.checkInDate).toISOString().split('T')[0];
    document.getElementById('checkOutDate').value = new Date(booking.checkOutDate).toISOString().split('T')[0];
    document.getElementById('totalPrice').value = booking.totalPrice;
    document.getElementById('status').value = booking.status;
    document.getElementById('specialRequests').value = booking.specialRequests || '';
    
    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    modal.show();
  }
  
  // Save booking (create or update)
  async function saveBooking() {
    const form = document.getElementById('bookingForm');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const bookingId = document.getElementById('bookingId').value;
    const data = {
      roomName: document.getElementById('roomName').value,
      roomType: document.getElementById('roomType').value,
      guestName: document.getElementById('guestName').value,
      guestEmail: document.getElementById('guestEmail').value,
      guestPhone: document.getElementById('guestPhone').value,
      numberOfGuests: document.getElementById('numberOfGuests').value,
      checkInDate: document.getElementById('checkInDate').value,
      checkOutDate: document.getElementById('checkOutDate').value,
      totalPrice: document.getElementById('totalPrice').value,
      status: document.getElementById('status').value,
      specialRequests: document.getElementById('specialRequests').value
    };
    
    try {
      const url = bookingId ? `/api/bookings/${bookingId}` : '/api/bookings';
      const method = bookingId ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
        await loadBookings();
        alert(bookingId ? 'Booking updated successfully!' : 'Booking created successfully!');
      } else {
        const result = await response.json();
        if (response.status === 403) {
          alert('Access Denied: ' + (result.error || 'You do not have permission to perform this action.'));
        } else {
          alert('Error: ' + (result.error || 'Failed to save booking'));
        }
      }
    } catch (error) {
      console.error('Save error:', error);
      alert('Network error. Please try again.');
    }
  }
  
  // Delete booking
  async function deleteBooking(id) {
    // Check if user is admin
    if (!currentUser || currentUser.role !== 'admin') {
      alert('Access Denied: Only administrators can delete bookings.');
      return;
    }
    
    const booking = allBookings.find(b => b._id === id);
    if (!booking) return;
    
    if (!confirm(`Are you sure you want to delete the booking for ${booking.guestName}?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/api/bookings/${id}`, {
        method: 'DELETE',
        credentials: 'same-origin'
      });
      
      if (response.ok) {
        await loadBookings();
        alert('Booking deleted successfully!');
      } else {
        const result = await response.json();
        if (response.status === 403) {
          alert('Access Denied: ' + (result.error || 'You do not have permission to perform this action.'));
        } else {
          alert('Error: ' + (result.error || 'Failed to delete booking'));
        }
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Network error. Please try again.');
    }
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async function() {
    const isAuth = await checkAuth();
    if (isAuth) {
      await loadBookings();
    }
  });
</script>
</body>
</html>
