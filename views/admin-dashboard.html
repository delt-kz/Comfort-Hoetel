<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Comfort Hotel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Comfort Hotel - Admin Panel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container-fluid py-4">
  <h2 class="mb-4">Admin Dashboard</h2>
  
  <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button">Bookings</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button">Contacts</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button">API Endpoints</button>
    </li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <!-- Bookings Tab -->
    <div class="tab-pane fade show active" id="bookings" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">All Bookings</h5>
          <button class="btn btn-sm btn-primary" onclick="loadBookings()">Refresh</button>
        </div>
        <div class="card-body">
          <!-- Filter, Sort, Projection Controls -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Filter by Room Name</label>
              <input type="text" class="form-control form-control-sm" id="filterRoomName" placeholder="Room name...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Filter by Guest Email</label>
              <input type="email" class="form-control form-control-sm" id="filterGuestEmail" placeholder="Email...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Filter by Status</label>
              <select class="form-select form-select-sm" id="filterStatus">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Sort By</label>
              <select class="form-select form-select-sm" id="sortByBookings">
                <option value="created_at">Created Date</option>
                <option value="checkInDate">Check-in Date</option>
                <option value="checkOutDate">Check-out Date</option>
                <option value="totalPrice">Total Price</option>
                <option value="guestName">Guest Name</option>
                <option value="roomName">Room Name</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Sort Order</label>
              <select class="form-select form-select-sm" id="sortOrderBookings">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Show Fields (comma-separated, leave empty for all)</label>
              <input type="text" class="form-control form-control-sm" id="projectionBookings" placeholder="roomName,guestName,totalPrice,status">
              <small class="text-muted">Available: roomName, roomType, guestName, guestEmail, checkInDate, checkOutDate, duration, numberOfGuests, totalPrice, status</small>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-sm btn-success w-100" onclick="applyFiltersBookings()">Apply Filters</button>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3">
              <button class="btn btn-sm btn-secondary w-100" onclick="resetFiltersBookings()">Reset Filters</button>
            </div>
          </div>
          <div id="bookingsTable"></div>
        </div>
      </div>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">All Contacts</h5>
          <button class="btn btn-sm btn-primary" onclick="loadContacts()">Refresh</button>
        </div>
        <div class="card-body">
          <!-- Filter, Sort, Projection Controls -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Filter by Name</label>
              <input type="text" class="form-control form-control-sm" id="filterName" placeholder="Name...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Filter by Email</label>
              <input type="email" class="form-control form-control-sm" id="filterEmail" placeholder="Email...">
            </div>
            <div class="col-md-3">
              <label class="form-label">Sort By</label>
              <select class="form-select form-select-sm" id="sortByContacts">
                <option value="created_at">Created Date</option>
                <option value="name">Name</option>
                <option value="email">Email</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Sort Order</label>
              <select class="form-select form-select-sm" id="sortOrderContacts">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Show Fields (comma-separated, leave empty for all)</label>
              <input type="text" class="form-control form-control-sm" id="projectionContacts" placeholder="name,email,created_at">
              <small class="text-muted">Available: name, email, message, created_at</small>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-sm btn-success w-100" onclick="applyFiltersContacts()">Apply Filters</button>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-sm btn-secondary w-100" onclick="resetFiltersContacts()">Reset</button>
            </div>
          </div>
          <div id="contactsTable"></div>
        </div>
      </div>
    </div>

    <!-- API Endpoints Tab -->
    <div class="tab-pane fade" id="api" role="tabpanel">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Available API Endpoints</h5>
        </div>
        <div class="card-body">
          <h6>Contacts API</h6>
          <ul class="list-group mb-3">
            <li class="list-group-item"><code>GET /api/contacts</code> - Get all contacts (supports ?email=, ?name=, ?sortBy=, ?sortOrder=, ?fields=)</li>
            <li class="list-group-item"><code>GET /api/contacts/:id</code> - Get contact by ID</li>
            <li class="list-group-item"><code>POST /api/contacts</code> - Create new contact</li>
            <li class="list-group-item"><code>PUT /api/contacts/:id</code> - Update contact</li>
            <li class="list-group-item"><code>DELETE /api/contacts/:id</code> - Delete contact</li>
          </ul>

          <h6>Bookings API</h6>
          <ul class="list-group mb-3">
            <li class="list-group-item"><code>GET /api/bookings</code> - Get all bookings (supports ?roomName=, ?guestEmail=, ?status=, ?sortBy=, ?sortOrder=, ?fields=)</li>
            <li class="list-group-item"><code>GET /api/bookings/:id</code> - Get booking by ID</li>
            <li class="list-group-item"><code>POST /api/bookings</code> - Create new booking</li>
            <li class="list-group-item"><code>PUT /api/bookings/:id</code> - Update booking</li>
            <li class="list-group-item"><code>DELETE /api/bookings/:id</code> - Delete booking</li>
          </ul>

          <h6>Other API</h6>
          <ul class="list-group">
            <li class="list-group-item"><code>GET /api/info</code> - Get API information</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="bg-dark text-white text-center py-3 mt-5">
  <p>Â©2025 Comfort Hotel | Contact: maga25@gmail.com</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allBookings = [];
let allContacts = [];

$(document).ready(function() {
  loadBookings();
  loadContacts();
});

function loadBookings() {
  fetch('/api/bookings?sortBy=created_at&sortOrder=desc')
    .then(response => response.json())
    .then(bookings => {
      allBookings = bookings;
      displayBookings(bookings);
    })
    .catch(error => {
      $('#bookingsTable').html(`<div class="alert alert-danger">Error loading bookings: ${error.message}</div>`);
    });
}

function applyFiltersBookings() {
  const roomName = $('#filterRoomName').val().trim();
  const guestEmail = $('#filterGuestEmail').val().trim();
  const status = $('#filterStatus').val();
  const sortBy = $('#sortByBookings').val();
  const sortOrder = $('#sortOrderBookings').val();
  const fields = $('#projectionBookings').val().trim();

  let url = '/api/bookings?';
  const params = [];
  
  if (roomName) params.push(`roomName=${encodeURIComponent(roomName)}`);
  if (guestEmail) params.push(`guestEmail=${encodeURIComponent(guestEmail)}`);
  if (status) params.push(`status=${encodeURIComponent(status)}`);
  if (sortBy) params.push(`sortBy=${sortBy}`);
  if (sortOrder) params.push(`sortOrder=${sortOrder}`);
  if (fields) params.push(`fields=${encodeURIComponent(fields)}`);

  url += params.join('&');

  fetch(url)
    .then(response => response.json())
    .then(bookings => {
      allBookings = bookings;
      displayBookings(bookings);
    })
    .catch(error => {
      $('#bookingsTable').html(`<div class="alert alert-danger">Error: ${error.message}</div>`);
    });
}

function resetFiltersBookings() {
  $('#filterRoomName').val('');
  $('#filterGuestEmail').val('');
  $('#filterStatus').val('');
  $('#sortByBookings').val('created_at');
  $('#sortOrderBookings').val('desc');
  $('#projectionBookings').val('');
  loadBookings();
}

function displayBookings(bookings) {
  if (bookings.length === 0) {
    $('#bookingsTable').html('<p class="text-muted">No bookings found.</p>');
    return;
  }

  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Room</th>
            <th>Guest</th>
            <th>Check-in</th>
            <th>Check-out</th>
            <th>Duration</th>
            <th>Guests</th>
            <th>Price</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="bookingsTableBody">
  `;

  bookings.forEach(booking => {
    const checkIn = new Date(booking.checkInDate).toLocaleDateString();
    const checkOut = new Date(booking.checkOutDate).toLocaleDateString();
    const created = new Date(booking.created_at).toLocaleString();
    const statusBadge = booking.status === 'confirmed' ? 'success' : booking.status === 'cancelled' ? 'danger' : 'warning';
    
    html += `
      <tr data-booking-id="${booking._id}">
        <td><small>${booking._id.substring(0, 8)}...</small></td>
        <td>${booking.roomName}<br><small class="text-muted">${booking.roomType}</small></td>
        <td>${booking.guestName}<br><small class="text-muted">${booking.guestEmail}</small></td>
        <td>${checkIn}</td>
        <td>${checkOut}</td>
        <td>${booking.duration} days</td>
        <td>${booking.numberOfGuests}</td>
        <td>$${booking.totalPrice.toFixed(2)}</td>
        <td><span class="badge bg-${statusBadge}">${booking.status}</span></td>
        <td><small>${created}</small></td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editBooking('${booking._id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking._id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';
  $('#bookingsTable').html(html);
}


function loadContacts() {
  fetch('/api/contacts?sortBy=created_at&sortOrder=desc')
    .then(response => response.json())
    .then(contacts => {
      allContacts = contacts;
      displayContacts(contacts);
    })
    .catch(error => {
      $('#contactsTable').html(`<div class="alert alert-danger">Error loading contacts: ${error.message}</div>`);
    });
}

function applyFiltersContacts() {
  const name = $('#filterName').val().trim();
  const email = $('#filterEmail').val().trim();
  const sortBy = $('#sortByContacts').val();
  const sortOrder = $('#sortOrderContacts').val();
  const fields = $('#projectionContacts').val().trim();

  let url = '/api/contacts?';
  const params = [];
  
  if (name) params.push(`name=${encodeURIComponent(name)}`);
  if (email) params.push(`email=${encodeURIComponent(email)}`);
  if (sortBy) params.push(`sortBy=${sortBy}`);
  if (sortOrder) params.push(`sortOrder=${sortOrder}`);
  if (fields) params.push(`fields=${encodeURIComponent(fields)}`);

  url += params.join('&');

  fetch(url)
    .then(response => response.json())
    .then(contacts => {
      allContacts = contacts;
      displayContacts(contacts);
    })
    .catch(error => {
      $('#contactsTable').html(`<div class="alert alert-danger">Error: ${error.message}</div>`);
    });
}

function resetFiltersContacts() {
  $('#filterName').val('');
  $('#filterEmail').val('');
  $('#sortByContacts').val('created_at');
  $('#sortOrderContacts').val('desc');
  $('#projectionContacts').val('');
  loadContacts();
}

function displayContacts(contacts) {
  if (contacts.length === 0) {
    $('#contactsTable').html('<p class="text-muted">No contacts found.</p>');
    return;
  }

  let html = `
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Message</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="contactsTableBody">
  `;

  contacts.forEach(contact => {
    const created = new Date(contact.created_at).toLocaleString();
    const messagePreview = contact.message.length > 50 ? contact.message.substring(0, 50) + '...' : contact.message;
    
    html += `
      <tr data-contact-id="${contact._id}">
        <td><small>${contact._id.substring(0, 8)}...</small></td>
        <td>${contact.name}</td>
        <td>${contact.email}</td>
        <td>${messagePreview}</td>
        <td><small>${created}</small></td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="editContact('${contact._id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteContact('${contact._id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += '</tbody></table></div>';
  $('#contactsTable').html(html);
}


function editBooking(id) {
  fetch(`/api/bookings/${id}`)
    .then(response => response.json())
    .then(booking => {
      // Create a modal-like form for editing
      const status = prompt(`Current status: ${booking.status}\n\nEnter new status (pending/confirmed/cancelled):`, booking.status);
      if (status && ['pending', 'confirmed', 'cancelled'].includes(status.toLowerCase())) {
        const updatedBooking = {
          ...booking,
          status: status.toLowerCase(),
          checkInDate: booking.checkInDate,
          checkOutDate: booking.checkOutDate
        };
        updateBooking(id, updatedBooking);
      }
    })
    .catch(error => alert('Error: ' + error.message));
}

function updateBooking(id, data) {
  fetch(`/api/bookings/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    if (result.error) {
      alert('Error: ' + result.error);
    } else {
      alert('Booking updated successfully!');
      loadBookings();
    }
  })
  .catch(error => alert('Error: ' + error.message));
}

function deleteBooking(id) {
  if (!confirm('Are you sure you want to delete this booking?')) return;
  
  fetch(`/api/bookings/${id}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(result => {
      alert(result.message || 'Booking deleted successfully');
      loadBookings();
    })
    .catch(error => alert('Error: ' + error.message));
}

function editContact(id) {
  fetch(`/api/contacts/${id}`)
    .then(response => response.json())
    .then(contact => {
      const name = prompt('Name:', contact.name);
      if (name === null) return;
      
      const email = prompt('Email:', contact.email);
      if (email === null) return;
      
      const message = prompt('Message:', contact.message);
      if (message === null) return;
      
      if (!name || !email || !message) {
        alert('All fields are required!');
        return;
      }
      
      fetch(`/api/contacts/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, message })
      })
      .then(response => response.json())
      .then(result => {
        if (result.error) {
          alert('Error: ' + result.error);
        } else {
          alert('Contact updated successfully!');
          loadContacts();
        }
      })
      .catch(error => alert('Error: ' + error.message));
    })
    .catch(error => alert('Error: ' + error.message));
}

function deleteContact(id) {
  if (!confirm('Are you sure you want to delete this contact?')) return;
  
  fetch(`/api/contacts/${id}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(result => {
      alert(result.message || 'Contact deleted successfully');
      loadContacts();
    })
    .catch(error => alert('Error: ' + error.message));
}
</script>
</body>
</html>

