<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comfort Hotel - Book a Room</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/">Comfort Hotel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/rooms">Rooms</a></li>
        <li class="nav-item"><a class="nav-link active" href="/booking">Booking</a></li>
        <li class="nav-item"><a class="nav-link" href="/about">About Us</a></li>
        <li class="nav-item"><a class="nav-link" href="/contact">Contact</a></li>
        <li class="nav-item"><a class="nav-link" href="/admin">Admin</a></li>
      </ul>
      <select id="currencySelector" class="form-select form-select-sm ms-3" style="width: auto;">
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (€)</option>
        <option value="KZT">KZT (₸)</option>
        <option value="RUB">RUB (₽)</option>
      </select>
    </div>
  </div>
</nav>

<main class="container py-5">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <h2 class="mb-4">Book Your Room</h2>
      
      <div class="card">
        <div class="card-body">
          <form id="bookingForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="roomName" class="form-label">Room Name/Number</label>
                <input type="text" class="form-control" id="roomName" name="roomName" required placeholder="e.g., Deluxe Suite 201">
              </div>
              <div class="col-md-6">
                <label for="roomType" class="form-label">Room Type</label>
                <select class="form-control" id="roomType" name="roomType" required>
                  <option value="">Select Room Type</option>
                  <option value="single">Single Room</option>
                  <option value="double">Double Room</option>
                  <option value="suite">Luxury Suite</option>
                </select>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="checkInDate" class="form-label">Check-in Date</label>
                <input type="date" class="form-control" id="checkInDate" name="checkInDate" required>
              </div>
              <div class="col-md-6">
                <label for="checkOutDate" class="form-label">Check-out Date</label>
                <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" required>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="numberOfGuests" class="form-label">Number of Guests</label>
                <input type="number" class="form-control" id="numberOfGuests" name="numberOfGuests" min="1" max="10" required>
              </div>
              <div class="col-md-6">
                <label for="totalPrice" class="form-label">Total Price (USD)</label>
                <input type="number" class="form-control" id="totalPrice" name="totalPrice" step="0.01" min="0" required readonly>
                <small class="text-muted">Price will be calculated automatically</small>
              </div>
            </div>

            <hr>

            <h5 class="mb-3">Guest Information</h5>

            <div class="row mb-3">
              <div class="col-md-6">
                <label for="guestName" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="guestName" name="guestName" required>
              </div>
              <div class="col-md-6">
                <label for="guestEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="guestEmail" name="guestEmail" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="guestPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="guestPhone" name="guestPhone" placeholder="+7 777 777 77 77">
            </div>

            <div class="mb-3">
              <label for="specialRequests" class="form-label">Special Requests</label>
              <textarea class="form-control" id="specialRequests" name="specialRequests" rows="3" placeholder="Any special requests or preferences..."></textarea>
            </div>

            <div id="bookingResult" class="alert" style="display: none;"></div>

            <button type="submit" class="btn btn-danger btn-lg w-100">Confirm Booking</button>
          </form>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header bg-info">
          <h5 class="mb-0">View/Manage Bookings</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input type="email" class="form-control" id="searchEmail" placeholder="Search by email...">
          </div>
          <button type="button" class="btn btn-info" id="searchBookingsBtn">Search Bookings</button>
          <button type="button" class="btn btn-secondary" id="loadAllBookingsBtn">Load All Bookings</button>
          <div id="bookingsList" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="bg-dark text-white text-center py-3 mt-5">
  <p>©2025 Comfort Hotel | Contact: maga25@gmail.com</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let exchangeRates = {};
const roomPrices = { single: 50, double: 90, suite: 150 };

$(document).ready(function() {
  loadCurrency();
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  $('#checkInDate').attr('min', today);
  $('#checkOutDate').attr('min', today);

  // Pre-fill form from URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const roomType = urlParams.get('roomType');
  const roomName = urlParams.get('roomName');
  
  if (roomType) {
    $('#roomType').val(roomType);
  }
  if (roomName) {
    $('#roomName').val(roomName);
  }

  // Calculate price when dates or room type changes
  $('#roomType, #checkInDate, #checkOutDate, #numberOfGuests').on('change', calculatePrice);
  
  $('#bookingForm').on('submit', handleBookingSubmit);
  $('#searchBookingsBtn').on('click', searchBookings);
  $('#loadAllBookingsBtn').on('click', loadAllBookings);
  
  // Initial price calculation if room type is pre-filled
  if (roomType) {
    calculatePrice();
  }
});

function calculatePrice() {
  const roomType = $('#roomType').val();
  const checkIn = new Date($('#checkInDate').val());
  const checkOut = new Date($('#checkOutDate').val());
  const guests = parseInt($('#numberOfGuests').val()) || 1;

  if (roomType && checkIn && checkOut && checkOut > checkIn) {
    const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
    const basePrice = roomPrices[roomType] || 0;
    const totalPrice = basePrice * days * guests;
    $('#totalPrice').val(totalPrice.toFixed(2));
  } else {
    $('#totalPrice').val('0.00');
  }
}

function handleBookingSubmit(e) {
  e.preventDefault();
  
  const formData = {
    roomName: $('#roomName').val(),
    roomType: $('#roomType').val(),
    guestName: $('#guestName').val(),
    guestEmail: $('#guestEmail').val(),
    guestPhone: $('#guestPhone').val(),
    checkInDate: $('#checkInDate').val(),
    checkOutDate: $('#checkOutDate').val(),
    numberOfGuests: parseInt($('#numberOfGuests').val()),
    totalPrice: parseFloat($('#totalPrice').val()),
    specialRequests: $('#specialRequests').val()
  };

  const resultDiv = $('#bookingResult');
  resultDiv.hide().removeClass('alert-success alert-danger').addClass('alert-info');
  resultDiv.html('Processing booking...').show();

  fetch('/api/bookings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.insertedId) {
      resultDiv.removeClass('alert-info').addClass('alert-success');
      resultDiv.html(`✓ Booking confirmed! Booking ID: ${data.insertedId}`);
      $('#bookingForm')[0].reset();
      $('#totalPrice').val('0.00');
    } else {
      throw new Error(data.error || 'Booking failed');
    }
  })
  .catch(error => {
    resultDiv.removeClass('alert-info').addClass('alert-danger');
    resultDiv.html(`✗ Error: ${error.message}`);
  });
}

function searchBookings() {
  const email = $('#searchEmail').val().trim();
  let url = '/api/bookings';
  if (email) {
    url += `?guestEmail=${encodeURIComponent(email)}`;
  }
  loadBookings(url);
}

function loadAllBookings() {
  $('#searchEmail').val('');
  loadBookings('/api/bookings');
}

function loadBookings(url) {
  const listDiv = $('#bookingsList');
  listDiv.html('<p>Loading...</p>');

  fetch(url)
    .then(response => response.json())
    .then(bookings => {
      if (bookings.length === 0) {
        listDiv.html('<p class="text-muted">No bookings found.</p>');
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Room</th><th>Guest</th><th>Check-in</th><th>Check-out</th><th>Duration</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      
      bookings.forEach(booking => {
        const checkIn = new Date(booking.checkInDate).toLocaleDateString();
        const checkOut = new Date(booking.checkOutDate).toLocaleDateString();
        html += `
          <tr>
            <td>${booking.roomName}<br><small class="text-muted">${booking.roomType}</small></td>
            <td>${booking.guestName}<br><small class="text-muted">${booking.guestEmail}</small></td>
            <td>${checkIn}</td>
            <td>${checkOut}</td>
            <td>${booking.duration} days</td>
            <td>$${booking.totalPrice.toFixed(2)}</td>
            <td><span class="badge bg-${booking.status === 'confirmed' ? 'success' : booking.status === 'cancelled' ? 'danger' : 'warning'}">${booking.status}</span></td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="viewBooking('${booking._id}')">View</button>
              <button class="btn btn-sm btn-danger" onclick="deleteBooking('${booking._id}')">Delete</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      listDiv.html(html);
    })
    .catch(error => {
      listDiv.html(`<p class="text-danger">Error loading bookings: ${error.message}</p>`);
    });
}

function viewBooking(id) {
  fetch(`/api/bookings/${id}`)
    .then(response => response.json())
    .then(booking => {
      alert(`Booking Details:\n\nRoom: ${booking.roomName} (${booking.roomType})\nGuest: ${booking.guestName}\nEmail: ${booking.guestEmail}\nPhone: ${booking.guestPhone || 'N/A'}\nCheck-in: ${new Date(booking.checkInDate).toLocaleDateString()}\nCheck-out: ${new Date(booking.checkOutDate).toLocaleDateString()}\nDuration: ${booking.duration} days\nGuests: ${booking.numberOfGuests}\nPrice: $${booking.totalPrice.toFixed(2)}\nStatus: ${booking.status}\nSpecial Requests: ${booking.specialRequests || 'None'}`);
    })
    .catch(error => {
      alert('Error loading booking: ' + error.message);
    });
}

function deleteBooking(id) {
  if (!confirm('Are you sure you want to delete this booking?')) return;

  fetch(`/api/bookings/${id}`, { method: 'DELETE' })
    .then(response => response.json())
    .then(data => {
      alert(data.message || 'Booking deleted successfully');
      loadAllBookings();
    })
    .catch(error => {
      alert('Error deleting booking: ' + error.message);
    });
}

function loadCurrency() {
  const saved = localStorage.getItem('selectedCurrency');
  if (saved) {
    $('#currencySelector').val(saved);
  }
}

function saveCurrency(currency) {
  localStorage.setItem('selectedCurrency', currency);
}

$('#currencySelector').change(function() {
  saveCurrency($(this).val());
});
</script>
</body>
</html>

